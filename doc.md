## Cashflow Backend – Project Overview

This Laravel 12 application manages organizations’ cashflow: incomes, outgoings, budgeting plans, timelines, and settings. It exposes a RESTful API secured with Laravel Sanctum and ships with interactive API documentation.

### API Documentation

- Docs UI: `/docs/api`
- OpenAPI JSON: `/docs/openapi.json`

The docs are generated by Scramble and auto-reflect your routes under `api/`. In local environments anyone can view them; in other environments access requires an authenticated user per `viewApiDocs` gate in `AppServiceProvider`.

### Authentication

This API uses Laravel Sanctum. Send a Bearer token in the `Authorization` header for all authenticated endpoints.

```
Authorization: Bearer <token>
```

### High-Level API Map

Base path: `/api`

- Public
  - `GET /api/test` – Health/test probe
  - `POST /api/debug` – Simple debug endpoint
  - `POST /api/mock/saman` – Mock bank balance
  - `POST /api/mock/mellat` – Mock bank balance
  - `POST /api/mock/parsian` – Mock bank balance

- Authenticated (requires Sanctum)
  - `GET /api/user` – Current authenticated user
  - Uploads (`/api/upload`)
    - `GET /` – List uploads
    - `GET /{upload}` – Show upload
    - `POST /` – Create upload
    - `GET /{upload}/download` – Download file
    - `DELETE /{upload}` – Delete upload
  - Settings (`/api/settings`)
    - `GET /` – Get all settings
    - `GET /get` – Get a setting
    - `POST /set` – Set a setting
    - `POST /get-multiple` – Get multiple
    - `POST /set-multiple` – Set multiple
    - `GET /has` – Check if exists
    - `DELETE /delete` – Delete by key
    - `GET /by-prefix` – Get by prefix
    - `DELETE /by-prefix` – Delete by prefix
    - `POST /clear-cache` – Clear settings cache
  - Timeline (`/api/timeline`)
    - `GET /grouped/{organ}` – Grouped cashflow timeline
    - `GET /{organ}` – Timeline for an organization
    - `GET /{organ}/summary` – Summary stats
    - `POST /{organ}/refresh` – Refresh timeline data
  - Admin & Organ modules
    - Additional routes are loaded from `routes/admin.php` and `routes/organ.php` (not listed here). See the API docs UI for the full, up‑to‑date list.

### Domain Concepts

- Organization (Organ): Entity whose cashflow is tracked.
- Cash Movements: Incomes and Outgoings recorded over time.
- Budget & Plans: Targets and allocations for upcoming periods.
- Timeline & Summary: Views aggregating cash movements into chronological and summary forms.
- Settings: Application and organization‑level configuration.
- Uploads: File storage for related documents.

### Developer Notes

- Framework: Laravel 12 (PHP 8.3)
- Auth: Laravel Sanctum
- Docs: Dedoc Scramble (`config/scramble.php`) with Stoplight Elements UI (`resources/views/scramble/index.blade.php`)
- Providers: `bootstrap/providers.php` registers Scramble and app providers
- Routing: configured in `bootstrap/app.php`

### Working With the API Docs

- View: open `/docs/api` in your browser.
- Export OpenAPI: download from `/docs/openapi.json` (the output path is `api.json` if you save it locally).

### Testing & Quality

- Docs tests: see `tests/Feature/ScrambleDocsTest.php`.
- Run tests: `php artisan test`
- Code style: `vendor/bin/pint --dirty`

## Detailed Section Docs

### Authentication (`/api/auth`)

- `POST /api/auth/login`
  - Body: `{ "email": "user@example.com", "password": "secret" }`
  - Response (200): `{ "token": "<sanctum_token>", ... }` (exact shape per controller)

- `POST /api/auth/logout` (requires Bearer token)
  - Response (200): `{ "ok": true }`

Include on all protected routes:

```
Authorization: Bearer <token>
```

### Uploads (`/api/upload`)

- `GET /api/upload` – list uploads
  - Response (200):

  ```json
  {
    "data": [
      { "id": 1, "name": "statement.pdf", "size": 34567, "created_at": "2025-10-01T10:20:30Z" }
    ]
  }
  ```

- `GET /api/upload/{upload}` – get upload
  - Response: `{ "data": { "id": 1, "name": "statement.pdf" } }`

- `POST /api/upload` – create upload
  - Content-Type: `multipart/form-data`
  - Fields: `file` (binary), optional metadata
  - Response (201): `{ "data": { "id": 2, "name": "..." } }`

- `GET /api/upload/{upload}/download` – binary response

- `DELETE /api/upload/{upload}` – Response (204): empty

### Settings (`/api/settings`)

- `GET /api/settings` – list
- `GET /api/settings/get?key=app.locale`
- `POST /api/settings/set` – `{ "key": "app.locale", "value": "en" }`
- `POST /api/settings/get-multiple` – `{ "keys": ["a","b"] }`
- `POST /api/settings/set-multiple` – `{ "values": { "a":1, "b":2 } }`
- `GET /api/settings/has?key=a`
- `DELETE /api/settings/delete` – `{ "key": "a" }`
- `GET /api/settings/by-prefix?prefix=organ.`
- `DELETE /api/settings/by-prefix` – `{ "prefix": "organ." }`
- `POST /api/settings/clear-cache`

### Timeline (`/api/timeline`)

- `GET /api/timeline/grouped/{organ}` – grouped cashflow
  - Example:

  ```json
  {
    "data": {
      "income": [{ "month": "2025-09", "amount": 1200000 }],
      "outgoings": [{ "month": "2025-09", "amount": 800000 }]
    }
  }
  ```

- `GET /api/timeline/{organ}` – detailed entries

- `GET /api/timeline/{organ}/summary` – KPIs
  - Example: `{ "data": { "balance": 400000, "income": 1200000, "outgoings": 800000 } }`

- `POST /api/timeline/{organ}/refresh` – `{ "ok": true }`

### Admin Module (`/api/admin`)

Requires `is-admin` middleware and granular permissions (`App\\Constants\\AdminPermissionKey`). Key areas:

- Password reset: `POST /api/admin/reset-password`

- Monthly Income/Expense (`/api/admin/monthly-income-expense`)
  - Deposits
    - `GET /deposits`
    - `GET /deposits/{depositId}/months`
    - `GET /deposits/{depositId}`
    - `GET /deposits/{depositId}/yearly-summary`
    - `GET /deposits/{depositId}/detailed-changes`
    - `GET /all-deposits`
  - Organs
    - `GET /organs`
    - `GET /organs/{organId}/months`
    - `GET /organs/{organId}`
    - `GET /organs/{organId}/yearly-summary`
    - `GET /all-organs`

- Users (`/api/admin/user`) – list/show/create/update/delete, block/unblock
- Organs (`/api/admin/organ`) – CRUD, `GET /{organ}/allocation`
- Deposits (`/api/admin/deposit`) – CRUD
- Banks (`/api/admin/bank`) – CRUD
- Admins (`/api/admin/admin`) – CRUD
- Permissions (`/api/admin/permission`) – list/show/update
- Roles (`/api/admin/role`) – list/show/create/update
- Access (`/api/admin/access`) – list/show/update

### Organ Module (`/api/organ`)

Requires `is-organ` middleware and organ permissions (`App\\Constants\\OrganPermissionKey`).

- Banks (`/api/organ/bank`) – list/show/create/update/delete
- Deposits (`/api/organ/deposit`) – list/types/show/create/update/delete

### Mock & Utilities

- `POST /api/mock/saman|mellat|parsian` – mocked balances
  - Response: `{ "data": { "balance": 1000000000 } }`

- `POST /api/debug` – `{ "ok": true }`
